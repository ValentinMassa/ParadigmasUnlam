pipeline {
    agent any
    
    tools {
        // Configura estos nombres en Jenkins -> Manage Jenkins -> Global Tool Configuration
        maven 'Maven'  // Cambia esto si tu instalaciÃ³n de Maven tiene otro nombre
        jdk 'JDK-17'   // Cambiado a JDK-17 (puedes usar JDK-11 si prefieres)
    }
    
    environment {
        // Variables de entorno personalizadas
        PROJECT_DIR = 'testing_jenkins/CÃ­rculos e intersecciones/CirculosEIntersecciones'
        MAVEN_OPTS = '-Dmaven.test.failure.ignore=false'
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'ğŸ”„ Obteniendo cÃ³digo fuente del repositorio...'
                checkout scm
                echo "âœ“ Rama: ${env.GIT_BRANCH}"
                echo "âœ“ Commit: ${env.GIT_COMMIT}"
            }
        }
        
        stage('Build') {
            steps {
                echo 'ğŸ”¨ Compilando el proyecto...'
                dir("${PROJECT_DIR}") {
                    script {
                        if (isUnix()) {
                            sh 'mvn clean compile'
                        } else {
                            bat 'mvn clean compile'
                        }
                    }
                }
                echo 'âœ“ CompilaciÃ³n exitosa'
            }
        }
        
        stage('Test') {
            steps {
                echo 'ğŸ§ª Ejecutando tests...'
                dir("${PROJECT_DIR}") {
                    script {
                        if (isUnix()) {
                            sh 'mvn test'
                        } else {
                            bat 'mvn test'
                        }
                    }
                }
            }
            post {
                always {
                    echo 'ğŸ“Š Publicando resultados de tests...'
                    junit allowEmptyResults: true, testResults: '**/target/surefire-reports/*.xml'
                    
                    // Archivar reportes de tests
                    publishHTML(target: [
                        allowMissing: true,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: "${PROJECT_DIR}/target/surefire-reports",
                        reportFiles: '*.html',
                        reportName: 'Test Report'
                    ])
                }
                success {
                    echo 'âœ“ Todos los tests pasaron correctamente'
                }
                failure {
                    echo 'âœ— Algunos tests fallaron. Revisa el reporte.'
                }
            }
        }
        
        stage('Code Coverage') {
            steps {
                echo 'ğŸ“ˆ Generando reporte de cobertura...'
                dir("${PROJECT_DIR}") {
                    script {
                        if (isUnix()) {
                            sh 'mvn jacoco:report || true'
                        } else {
                            bat 'mvn jacoco:report || true'
                        }
                    }
                }
            }
        }
        
        stage('Package') {
            steps {
                echo 'ğŸ“¦ Empaquetando aplicaciÃ³n...'
                dir("${PROJECT_DIR}") {
                    script {
                        if (isUnix()) {
                            sh 'mvn package -DskipTests'
                        } else {
                            bat 'mvn package -DskipTests'
                        }
                    }
                }
                echo 'âœ“ Empaquetado exitoso'
            }
            post {
                success {
                    // Archivar el JAR generado
                    archiveArtifacts artifacts: '**/target/*.jar', 
                                   fingerprint: true,
                                   allowEmptyArchive: true
                }
            }
        }
        
        stage('Quality Gate') {
            steps {
                echo 'âœ… Verificando calidad del cÃ³digo...'
                script {
                    def testResults = junit '**/target/surefire-reports/*.xml'
                    if (testResults.totalCount == 0) {
                        error('No se encontraron tests')
                    }
                    echo "Tests ejecutados: ${testResults.totalCount}"
                    echo "Tests exitosos: ${testResults.passCount}"
                    echo "Tests fallidos: ${testResults.failCount}"
                }
            }
        }
    }
    
    post {
        success {
            echo 'ğŸ‰ Â¡Pipeline ejecutado exitosamente!'
            echo "Build #${env.BUILD_NUMBER} completado"
            echo "DuraciÃ³n: ${currentBuild.durationString}"
        }
        failure {
            echo 'âŒ El pipeline fallÃ³. Revisa los logs.'
            echo "Build #${env.BUILD_NUMBER} fallÃ³"
        }
        unstable {
            echo 'âš ï¸ El build es inestable (tests fallaron)'
        }
        always {
            echo 'ğŸ§¹ Generando reporte final...'
            
            // Mostrar resumen
            script {
                def status = currentBuild.currentResult
                def duration = currentBuild.durationString
                echo """
                â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                ğŸ“‹ RESUMEN DEL BUILD
                â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                Estado: ${status}
                DuraciÃ³n: ${duration}
                Build: #${env.BUILD_NUMBER}
                Rama: ${env.GIT_BRANCH}
                â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                """
            }
            
            // Limpiar workspace (comentar si quieres mantener los archivos)
            // cleanWs()
        }
    }
}
